#!/bin/bash

# Controls a drop-term terminal terminal for use in i3wm

DISPLAY_WIDTH=1920
DISPLAY_HEIGHT="$(xdpyinfo | grep dimensions | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/' | sed -r 's/.*x//')"
TERMINAL_WIDTH=1920
TERMINAL_HEIGHT=$((DISPLAY_HEIGHT/4))
POLYBAR_OFFSET=33 #bar offset in pixels

TERMINAL="kitty --name drop-term tmux" # Change this to whatever terminal emulator you want

# Temporary file to record the terminal state
TERMINAL_STATE=/tmp/drop-term_state

# Adjust the sleep time and step size as necessary to make the animation smooth
STEP_SIZE=5
SLEEP_TIME=0.002

usage() {
    echo "Open/closes a drop-term terminal"
    echo "Usage: ./kittydown <start|open|close|toggle>"
}

term_launch() {
    i3-msg -q exec "$(echo $TERMINAL)"
    local term_pid=$(pgrep -f "$(echo $TERMINAL)")
    
    # Wait for terminal to open
    xdotool search --sync --pid $term_pid > /dev/null
    i3-msg -q [instance=drop-term] mark drop-term # Mark the terminal so we can identify it 
    i3-msg -q [con_mark=drop-term] floating enable
    i3-msg -q [con_mark=drop-term] resize set 100 ppt $TERMINAL_HEIGHT px 
    i3-msg -q [con_mark=drop-term] move position 0px 0px #$(( (DISPLAY_WIDTH - TERMINAL_WIDTH)/2 )) 0
    i3-msg -q [con_mark=drop-term] move scratchpad
    
    echo "closed" > $TERMINAL_STATE
}

term_open() {
    if [ "$(cat $TERMINAL_STATE)" == "closed" ]; then
        echo "animating" > $TERMINAL_STATE
        i3-msg -q [con_mark=drop-term] scratchpad show
        i3-msg -q move up $((TERMINAL_HEIGHT - POLYBAR_OFFSET))
        
        for i in `seq 1 $STEP_SIZE $TERMINAL_HEIGHT`; do
            i3-msg -q [con_mark=drop-term] move down $STEP_SIZE
            sleep $SLEEP_TIME
        done
        echo "open" > $TERMINAL_STATE
    fi
}

term_close() {
    if [ "$(cat $TERMINAL_STATE)" == "open" ]; then
        echo "animating" > $TERMINAL_STATE
        i3-msg -q [con_mark=drop-term] focus
        for i in `seq 1 $STEP_SIZE $TERMINAL_HEIGHT`; do
            i3-msg -q [con_mark=drop-term] move up $STEP_SIZE
            sleep $SLEEP_TIME
        done
        i3-msg -q [con_mark=drop-term] scratchpad show
        echo "closed" > $TERMINAL_STATE
    fi
}

term_toggle() {
    case "$(cat $TERMINAL_STATE)" in
        open)   term_close;;
        closed) term_open;;
        *)      ;;
    esac
}

if [ $# != 1 ]; then
    usage
    exit 1
else
    case $1 in
        start)  term_launch;;
        open)   term_open;;
        close)  term_close;;
        toggle) term_toggle;;
        *)      usage; exit 1;;
    esac
fi


